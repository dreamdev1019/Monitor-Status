<!DOCTYPE html>
<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.2.1/Chart.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.5/socket.io.min.js"></script>
    <style>
        * {
            font-family: Helvetica Neue, Helvetica, Arial, sans-serif;
        }

        h1 {
            font-size: 3em;
            color: #222222;
            margin: 0;
        }

        h5 {
            margin: 0;
            color: #888888;
        }

        p {
            font-size: 0.7em;
            color: #888888;
        }

        .stats-column {
            flex: 0 0 200px;
        }

        .container {
            display: flex;
            flex-direction: row;
            margin-top: 20px;
        }

        .footer {
            position: fixed;
            margin: auto;
            text-align: center;
            left: 0;
            right: 0;
            bottom: 0;
        }
    </style>
</head>
<body>
<div style="width: 400px; margin: auto">
    <h3>Express Status</h3>
    <div class="container">
        <div class="stats-column">
            <h5>CPU Usage</h5>
            <h1 id="cpuStat">- %</h1>
        </div>
        <canvas id="cpuChart" width="400" height="100"></canvas>
    </div>
    <div class="container">
        <div class="stats-column">
            <h5>Memory Usage</h5>
            <h1 id="memStat">- %</h1>
        </div>
        <canvas id="memChart" width="400" height="100"></canvas>
    </div>
    <div class="container">
        <div class="stats-column">
            <h5>Requests per second</h5>
            <h1 id="rpsStat">-</h1>
        </div>
        <canvas id="rpsChart" width="400" height="100"></canvas>
    </div>
    <div class="container">
        <div class="stats-column">
            <h5>Response Time Mean</h5>
            <h1 id="responseTimeStat">- ms</h1>
        </div>
        <canvas id="responseTimeChart" width="400" height="100"></canvas>
    </div>
    <div class="container">
        <div class="stats-column">
            <h5>Response status codes</h5>
            <h1 id="statusCodeStat">-</h1>
        </div>
        <canvas id="statusCodeChart" width="400" height="100"></canvas>
    </div>
    <div class="footer">
        <p>Powered by Socket.io & Chart.js</p>
    </div>
</div>
<script>
    Chart.defaults.global.defaultFontSize = 8;
    Chart.defaults.global.animation.duration = 500;
    Chart.defaults.global.legend.display = false;
    Chart.defaults.global.elements.line.backgroundColor = "rgba(0,0,0,0)";
    Chart.defaults.global.elements.line.borderColor = "rgba(0,0,0,0.9)";
    Chart.defaults.global.elements.line.borderWidth = 2;

    var socket = io('http://localhost:41338');
    var labels = [];
    var cpuDataset = [{
        label: 'CPU Usage in %',
        data: [],
        lineTension: 0.3,
        pointRadius: 0,
    }];

    var memDataset = [{
        label: 'Memory Usage in MB',
        data: [],
        lineTension: 0.6,
        pointRadius: 0,
    }];

    var responseTimeDataset = [{
        label: 'Mean Response time',
        data: [],
        lineTension: 0.6,
        pointRadius: 0,
    }];

    var rpsDataset = [{
        label: 'Requests per second',
        data: [],
        lineTension: 0.6,
        pointRadius: 0,
    }];

    var statusCodesDataset = [{
        label: 'Memory Usage in MB',
        data: [],
        lineTension: 0.6,
        pointRadius: 0,
    }];

    var defaultOptions = {
        scales: {
            yAxes: [{
                ticks: {
                    beginAtZero: true
                }
            }],
            xAxes: [{
                type: 'time',
                time: {
                    unitStepSize: 30
                },
                gridLines: {
                    display: false
                }
            }]
        },
        tooltips: {
            enabled: false
        }
    };

    var cpuStat = document.getElementById('cpuStat');
    var memStat = document.getElementById('memStat');
    var responseTimeStat = document.getElementById('responseTimeStat');
    var rpsStat = document.getElementById('rpsStat');
    var cpuChartCtx = document.getElementById("cpuChart");
    var memChartCtx = document.getElementById("memChart");
    var rpsChartCtx = document.getElementById("rpsChart");
    var responseTimeChartCtx = document.getElementById("responseTimeChart");
    var statusCodeChartCtx = document.getElementById("statusCodeChart");
    var cpuChart = new Chart(cpuChartCtx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: cpuDataset,
        },
        options: defaultOptions
    });

    var memChart = new Chart(memChartCtx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: memDataset,
        },
        options: defaultOptions
    });

    var rpsChart = new Chart(rpsChartCtx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: responseTimeDataset,
        },
        options: defaultOptions
    });

    var responseTimeChart = new Chart(responseTimeChartCtx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: responseTimeDataset,
        },
        options: defaultOptions
    });

    var statusCodeChart = new Chart(statusCodeChartCtx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: statusCodesDataset,
        },
        options: defaultOptions
    });

    socket.on('stats', function (data) {
        console.log(data);
        cpuStat.textContent = data.osStats[data.osStats.length - 1].cpu.toFixed(1) + '%';
        cpuChart.data.datasets[0].data = data.osStats.map(function(point) { return point.cpu; });
        cpuChart.data.labels = data.osStats.map(function(point) { return point.timestamp; });
        cpuChart.update();

        memStat.textContent = data.osStats[data.osStats.length - 1].memory.toFixed(1) + 'MB';
        memChart.data.datasets[0].data = data.osStats.map(function(point) { return point.memory; });
        memChart.data.labels = data.osStats.map(function(point) { return point.timestamp; });
        memChart.update();

        if (data.responses.length > 0) {
            responseTimeStat.textContent = data.responses[data.responses.length - 1].mean.toFixed(1) + 'ms';
            responseTimeChart.data.datasets[0].data = data.responses.map(function (point) {
                return point.mean;
            });
            responseTimeChart.data.labels = data.responses.map(function (point) {
                return point.timestamp;
            });
            responseTimeChart.update();
        }
    });
</script>
</body>
</html>